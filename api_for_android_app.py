# -*- coding: utf-8 -*-
"""api for android app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1m09XZd9SPKpsy8YNMfZzP7o66xuQ83y5

Installing the dependencies:
"""

!pip install fastapi
!pip install uvicorn
!pip install pickle
!pip install pydantic
!pip install scikit-learn
!pip install requests
!pip install pypi-json
!pip install pyngrok
!pip install nest-asyncio

from fastapi import FastAPI
from pydantic import BaseModel
import pickle
import json
import uvicorn
from pyngrok import ngrok
from fastapi.middleware.cors import CORSMiddleware
import nest_asyncio

app = FastAPI() # using FastAPI to build an API for the diabetes prediction model

"""**CORS** is a security mechanism implemented in web browsers that prevents web pages from making requests to a different domain than the one that served the web page. This is a crucial security feature to prevent malicious sites from accessing sensitive data.

Following cell does the configuration of CORS which relaxes the browser's security policy to allow other web applications (potentially hosted on different domains) to make requests to our FastAPI server
"""

# configuring the Cross-Origin Resource Sharing (CORS) for our FastAPI application

origins = ["*"] # request from any origin 9domain) will be allowed to access our API

app.add_middleware(
    CORSMiddleware,
    allow_origins = origins,
    allow_credentials = True, # browser is allowed to send cookies, HTTP authentication, or SSL client certificates with the cross-origin request.
    allow_methods=["*"], # allows all standard HTTP methods (GET, POST, PUT, DELETE, OPTIONS, etc.) to be used in cross-origin requests.
    allow_headers = ["*"] # allows all headers to be sent in cross-origin requests.
)

class model_input(BaseModel):
  Pregnancies: int
  Glucose : int
  BloodPressure: int
  SkinThickness: int
  Insulin: int
  BMI: float
  DiabetesPedigreeFunction: float
  Age: int

# loading the saved model
diabetes_model = pickle.load(open('diabetes_trained_model.sav', 'rb'))

@app.post('/diabetes_prediction') # tells FastAPI that the function immediately following it (diabetes_predd in this case) should be executed when API receives an HTTP POST request to the /diabetes_prediction URL path.

# HTTP POST requests are typically used to send data to the server to create or update a resource. Here, you're sending the diabetes prediction input parameters to the server.
# So, whenever someone sends a POST request to your-api-url/diabetes_prediction, FastAPI will call your diabetes_predd function to handle that request.

def diabetes_predd(input_parameters: model_input): # input_parameters argument of diabetes_predd function is expected to be an instance of the model_input class.
  input_data = input_parameters.json()
  input_dictionary = json.loads(input_data)

  preg = input_parameters.Pregnancies
  glu = input_parameters.Glucose
  bp = input_parameters.BloodPressure
  skin = input_parameters.SkinThickness
  insulin = input_parameters.Insulin
  bmi = input_parameters.BMI
  dpf = input_parameters.DiabetesPedigreeFunction
  age = input_parameters.Age

  input_list = [preg, glu, bp, skin, insulin, bmi, dpf, age]

  prediction = diabetes_model.predict([input_list])

  if prediction[0]==0:
    return 'The person is not diabetic'
  else:
    return 'The person is diabetic'

!ngrok authtoken 35BvKGrlChQSaa5uBIr7GEVRDpe_7SffoWvLaKBQxj8VRSJ6U # replace with your ngrok auth token

import asyncio

ngrok_tunnel = ngrok.connect(8000)
print('Public URL:', ngrok_tunnel.public_url)
nest_asyncio.apply()

# Explicitly configure and run the uvicorn server
config = uvicorn.Config(app, host="0.0.0.0", port=8000, loop="asyncio")
server = uvicorn.Server(config)

# Get the current running event loop and run the server's serve method
loop = asyncio.get_event_loop()
loop.run_until_complete(server.serve())

